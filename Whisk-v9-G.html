<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WHISK Framework - Enhanced Risk Assessment</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --light-gray: #e2e8f0;
            --card-bg: #ffffff;
            --section-bg: #f1f5f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--section-bg);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: var(--gray);
            max-width: 800px;
            margin: 0 auto;
        }

        .assessment-mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .assessment-mode-selector label {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .assessment-mode-selector input {
            display: none;
        }
        .assessment-mode-selector input:checked + label {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .framework-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .framework-section.highlight {
            box-shadow: 0 0 0 3px var(--primary);
            transform: scale(1.01);
        }

        #chained-vulnerability-assessment .framework-section {
            border: 1px solid var(--light-gray);
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
        }

        h3 {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: white;
            opacity: 0.95;
            text-align: center;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        select, input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            background: white;
            font-size: 1rem;
        }
        
        .results-panel {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            color: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 20px;
        }
        
        .risk-score-container {
            text-align: center;
            margin: 20px 0;
        }
        
        .risk-score {
            font-size: 4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .risk-level {
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        .breakdown-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        
        .breakdown-title {
            font-size: 0.95rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .breakdown-value {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: block;
            margin: 30px auto 0 auto;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .btn-secondary { background-color: var(--gray); }
        .btn-secondary:hover { background-color: var(--dark); }

        .btn-danger {
            background-color: var(--danger);
            font-size: 0.9rem;
            padding: 8px 12px;
            margin: 0;
        }
       
        .vulnerability-subclass {
            position: relative;
            padding: 25px;
            margin-bottom: 20px;
        }

        .vulnerability-subclass .vulnerability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vulnerability-subclass .vulnerability-header .form-group {
            flex-grow: 1;
            margin: 0 20px 0 0;
        }

        .chain-layout {
            display: grid;
            grid-template-columns: 1fr 450px;
            gap: 30px;
            align-items: start;
        }

        .chain-results-container, .prioritization-container {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .prioritization-list { list-style-type: none; padding: 0; }

        .prio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .prio-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .prio-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .prio-reason {
            padding: 4px 8px;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: bold;
            color: white;
        }

        .prio-impact { text-align: right; }
        .prio-reduction-label { font-size: 0.8rem; opacity: 0.7; display: block; }
        .prio-reduction-value { font-size: 1.4rem; font-weight: bold; color: var(--success); }

        .prio-level-1 { background-color: var(--danger); }
        .prio-level-2 { background-color: var(--warning); }
        .prio-level-3 { background-color: var(--info); }

        .dependency-graph-container {
            position: sticky;
            top: 20px;
        }
        #dependency-graph {
            width: 100%;
            height: auto;
            min-height: 400px;
        }

        .graph-node { cursor: pointer; }
        .graph-node circle { transition: all 0.3s ease; }
        .graph-node text { font-size: 12px; fill: white; pointer-events: none; }
        .graph-node.highlight circle { stroke-width: 4px; }
        .graph-link { stroke: rgba(255,255,255,0.3); stroke-width: 2px; }

        @media (max-width: 1200px) {
            .chain-layout { grid-template-columns: 1fr; }
            .dependency-graph-container { position: static; margin-top: 30px;}
        }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .risk-score { font-size: 2.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>WHISK Framework</h1>
            <div class="subtitle">Enhanced Payment Security Risk Assessment</div>
        </header>

        <div class="assessment-mode-selector">
            <input type="radio" id="mode-single" name="assessment-mode" value="single" checked>
            <label for="mode-single">Single Vulnerability</label>
            <input type="radio" id="mode-chain" name="assessment-mode" value="chain">
            <label for="mode-chain">Chained Vulnerability</label>
        </div>

        <div id="single-vulnerability-assessment">
            <div id="single-vulnerability-form"></div>
            <button class="btn" id="calculateBtn">Calculate Risk Score</button>
            <div class="results-panel" id="single-results-panel">
                <h2>Risk Assessment Results</h2>
                <div class="risk-score-container">
                    <div class="risk-score" id="riskScore">0</div>
                    <div class="risk-level" id="riskLevel">MINIMAL RISK</div>
                </div>
                <div class="breakdown-grid">
                    <div class="breakdown-card">
                        <div class="breakdown-title">CVSS Base Score</div>
                        <div class="breakdown-value" id="baseScore">0.0</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-title">Data Impact</div>
                        <div class="breakdown-value" id="dataImpact">1.0x</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-title">Business Impact</div>
                        <div class="breakdown-value" id="businessImpact">1.0x</div>
                    </div>
                    <div class="breakdown-card">
                        <div class="breakdown-title">PCI DSS Impact</div>
                        <div class="breakdown-value" id="pciMod">1.0x</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chained-vulnerability-assessment" style="display: none;">
            <div class="chain-layout">
                <div id="vulnerability-chain-forms">
                    <div id="vulnerability-chain-container"></div>
                    <div class="vulnerability-chain-controls">
                        <button class="btn btn-secondary" id="addVulnerabilityBtn">+ Add Vulnerability</button>
                    </div>
                </div>
                <div id="chain-results-panel" class="results-panel" style="display: none;">
                    <h3>Live Dependency View</h3>
                    <div class="dependency-graph-container">
                        <svg id="dependency-graph"></svg>
                    </div>
                    <div class="chain-results-container">
                        <h3>Overall Chain Risk</h3>
                        <div class="risk-score-container">
                            <div class="risk-score" id="overallRiskScore">0</div>
                            <div class="risk-level" id="overallRiskLevel">MINIMAL RISK</div>
                        </div>
                    </div>
                     <div class="prioritization-container">
                        <h3>Prioritization & Impact</h3>
                        <ul id="prioritization-list" class="prioritization-list"></ul>
                    </div>
                </div>
            </div>
            <button class="btn" id="calculateChainBtn">Calculate Overall Chain Risk</button>
        </div>
    </div>

    <!-- TEMPLATE -->
    <template id="vulnerability-template">
        <div class="framework-section vulnerability-subclass">
            <div class="vulnerability-header">
                <div class="form-group">
                    <label>Vulnerability Name/Identifier</label>
                    <input type="text" class="vulnerabilityName" placeholder="e.g., SQL Injection in Orders API">
                </div>
                <button class="btn btn-danger remove-subclass-btn" style="display: none;">Remove</button>
            </div>

            <h2>CVSS & Helcim-Specific Metrics</h2>
            <div class="form-grid">
                <!-- Metrics -->
                <div class="form-group"><label>Attack Vector</label><select class="attackVector"><option value="N">Network</option><option value="A">Adjacent</option><option value="L">Local</option><option value="P">Physical</option></select></div>
                <div class="form-group"><label>Attack Complexity</label><select class="attackComplexity"><option value="L">Low</option><option value="H">High</option></select></div>
                <div class="form-group"><label>Privileges Required</label><select class="userRole"><option value="new_merchant">Newly signed up merchant</option><option value="manager">Merchant general user</option><option value="admin">Merchant admin</option><option value="customer">Customer of merchant</option></select></div>
                <div class="form-group"><label>User Interaction</label><select class="userInteraction"><option value="R">Required</option><option value="N">None</option></select></div>
                <div class="form-group"><label>Scope</label><select class="scope"><option value="U">Unchanged</option><option value="C">Changed</option></select></div>
                <div class="form-group"><label>Confidentiality</label><select class="confidentiality"><option value="H">High</option><option value="L">Low</option><option value="N" selected>None</option></select>
                    <div class="sub-options confSubOptions" style="display:none;"><div class="sub-option"><label>Data Sensitivity</label><select class="confDataSensitivity"></select></div><div class="sub-option confSubclassOptions"><label>Data Subclass</label><select class="confDataSubclass"></select></div></div></div>
                <div class="form-group"><label>Integrity</label><select class="integrity"><option value="H">High</option><option value="L">Low</option><option value="N" selected>None</option></select>
                    <div class="sub-options intSubOptions" style="display:none;"><div class="sub-option"><label>Data Sensitivity</label><select class="intDataSensitivity"></select></div><div class="sub-option intSubclassOptions"><label>Data Subclass</label><select class="intDataSubclass"></select></div></div></div>
                <div class="form-group"><label>Availability</label><select class="availability"><option value="H">High</option><option value="L">Low</option><option value="N" selected>None</option></select></div>
                <div class="form-group"><label>Asset Class</label><select class="assetClass"><option value="critical">*.helcim.com</option><option value="high">*.myhelcim.com</option><option value="medium" selected>*.helcim.app</option></select></div>
                <div class="form-group"><label>Business Logic</label><select class="businessLogic"><option value="none" selected>Not selected</option><option value="all_merchants">Affects all merchants</option><option value="individual_merchant">Affects an individual merchant</option><option value="all_customers">Affects all customers</option><option value="specific_customers">Affects specific customers</option></select></div>
                <div class="form-group dependency-group" style="display: none;"><label>This vulnerability depends on:</label><select class="dependsOn"><option value="">None</option></select></div>
                 <div class="form-group"><label>Privilege Escalation</label><div class="checkbox-group"><label><input type="checkbox" class="cross_read"> Cross-merchant (read)</label><label><input type="checkbox" class="cross_write"> Cross-merchant (write)</label><label><input type="checkbox" class="same_read"> Same-merchant (read)</label><label><input type="checkbox" class="same_write"> Same-merchant (write)</label><label><input type="checkbox" class="token_escalation"> Via leaked tokens</label></div></div>
                <div class="form-group"><label>Affects PCI DSS</label><div class="checkbox-group"><label><input type="checkbox" class="pciDss"> Yes</label></div></div>
            </div>
        </div>
    </template>
    
    <script>
        // --- DATA AND CONSTANTS ---
        const dataSensitivityOptions = { H: [{ value: "red", text: "Red (Critical)" }, { value: "orange", text: "Orange (High)" }], L: [{ value: "yellow", text: "Yellow (Medium)" }, { value: "green", text: "Green (Low)" }] };
        const dataSubclassOptions = { red: ["Credit card number", "Bank account number", "SSN", "Driving license number"], orange: ["Merchant PII Private", "Customer PII Private", "Transactional data private"], yellow: ["General business data", "System logs"], green: ["Publicly accessible data"] };
        const userRoleScores = { new_merchant: 100, manager: 90, admin: 85, customer: 30 };
        const impactMultipliers = { red: 1.8, orange: 1.4, yellow: 1.0, green: 0.5 };
        const assetClassMultipliers = { critical: 1.5, high: 1.2, medium: 1.0 };
        const escalationMultipliers = { cross_read: 0.9, cross_write: 1.0, same_read: 0.6, same_write: 0.9, token: 0.8 };
        const businessLogicMultipliers = { none: 1.0, all_merchants: 1.8, individual_merchant: 1.4, all_customers: 1.3, specific_customers: 1.1 };
        const pciDssMultiplier = 2.5;
        const criticalDataBoost = 1.7;
        const vectorValues = { AV: { N: 0.85, A: 0.62, L: 0.55, P: 0.2 }, AC: { L: 0.77, H: 0.44 }, PR: { U: { N: 0.85, L: 0.62, H: 0.27 }, C: { N: 0.85, L: 0.68, H: 0.5 } }, UI: { N: 0.85, R: 0.62 }, S: { U: 'U', C: 'C' }, C: { H: 0.56, L: 0.22, N: 0 }, I: { H: 0.56, L: 0.22, N: 0 }, A: { H: 0.56, L: 0.22, N: 0 } };

        document.addEventListener('DOMContentLoaded', function() {
            // --- INITIALIZATION & SETUP ---
            const singleAssessmentContainer = document.getElementById('single-vulnerability-assessment');
            const chainedAssessmentContainer = document.getElementById('chained-vulnerability-assessment');
            const chainContainer = document.getElementById('vulnerability-chain-container');
            const vulnerabilityTemplate = document.getElementById('vulnerability-template');

            function setupModeSwitcher() {
                document.querySelectorAll('input[name="assessment-mode"]').forEach(radio => {
                    radio.addEventListener('change', function() {
                        const isChainMode = this.value === 'chain';
                        singleAssessmentContainer.style.display = isChainMode ? 'none' : 'block';
                        chainedAssessmentContainer.style.display = isChainMode ? 'block' : 'none';
                        if (isChainMode && chainContainer.children.length === 0) {
                            addVulnerabilitySubclass();
                        }
                    });
                });
            }

            function cloneTemplateToSingleForm() {
                const formContainer = document.getElementById('single-vulnerability-form');
                const templateContent = vulnerabilityTemplate.content.cloneNode(true);
                formContainer.appendChild(templateContent);
                attachEventListeners(formContainer.querySelector('.vulnerability-subclass'));
            }

            function addVulnerabilitySubclass() {
                const clone = vulnerabilityTemplate.content.cloneNode(true);
                const subclassDiv = clone.querySelector('.vulnerability-subclass');
                subclassDiv.id = 'subclass-' + Date.now();
                
                if (chainContainer.children.length > 0) {
                    clone.querySelector('.remove-subclass-btn').style.display = 'inline-block';
                }
                clone.querySelector('.dependency-group').style.display = 'block';
               
                chainContainer.appendChild(clone);
                const newForm = chainContainer.lastElementChild;
                attachEventListeners(newForm);
                updateAllDependencyDropdowns();
                newForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            function attachEventListeners(container) {
                 // Attach event listeners for dynamic sub-options
                container.querySelector('.confidentiality').addEventListener('change', e => updateDataSensitivityOptions(e.target));
                container.querySelector('.integrity').addEventListener('change', e => updateDataSensitivityOptions(e.target));
                container.querySelector('.confDataSensitivity').addEventListener('change', e => updateDataSubclassOptions(e.target));
                container.querySelector('.intDataSensitivity').addEventListener('change', e => updateDataSubclassOptions(e.target));

                // Initial setup for the new form's dynamic options
                updateDataSensitivityOptions(container.querySelector('.confidentiality'));
                updateDataSensitivityOptions(container.querySelector('.integrity'));

                // Attach live update listeners
                const inputs = container.querySelectorAll('select, input');
                inputs.forEach(input => input.addEventListener('change', () => {
                    if (document.getElementById('mode-chain').checked) {
                         calculateAndDisplayChainScore(true); // Run in "live" mode
                    }
                }));
                container.querySelector('.vulnerabilityName').addEventListener('input', () => {
                     if (document.getElementById('mode-chain').checked) {
                        updateAllDependencyDropdowns();
                        calculateAndDisplayChainScore(true);
                     }
                });
            }
             // Functions for dynamic impact metric dropdowns
            function updateDataSensitivityOptions(selectElement) {
                const type = selectElement.classList.contains('confidentiality') ? 'conf' : 'int';
                const container = selectElement.closest('.framework-section');
                const subOptionsContainer = container.querySelector(`.${type}SubOptions`);
                const sensitivitySelect = container.querySelector(`.${type}DataSensitivity`);
                
                subOptionsContainer.style.display = selectElement.value === 'N' ? 'none' : 'block';
                sensitivitySelect.innerHTML = '';
                
                if (selectElement.value !== 'N') {
                    const options = dataSensitivityOptions[selectElement.value];
                    options.forEach(option => {
                        sensitivitySelect.innerHTML += `<option value="${option.value}">${option.text}</option>`;
                    });
                }
                updateDataSubclassOptions(sensitivitySelect);
            }

            function updateDataSubclassOptions(sensitivitySelect) {
                 const type = sensitivitySelect.classList.contains('confDataSensitivity') ? 'conf' : 'int';
                 const container = sensitivitySelect.closest('.framework-section');
                 const subclassSelect = container.querySelector(`.${type}DataSubclass`);
                 subclassSelect.innerHTML = '';

                 if (sensitivitySelect.value) {
                     const options = dataSubclassOptions[sensitivitySelect.value] || [];
                     options.forEach(optionText => {
                        const value = optionText.toLowerCase().replace(/\s+/g, '_');
                        subclassSelect.innerHTML += `<option value="${value}">${optionText}</option>`;
                     });
                 }
            }


            function updateAllDependencyDropdowns() {
                const subclasses = Array.from(chainContainer.querySelectorAll('.vulnerability-subclass'));
                const options = subclasses.map(sc => ({
                    id: sc.id,
                    name: sc.querySelector('.vulnerabilityName').value.trim() || `Unnamed (${sc.id.slice(-4)})`
                }));

                subclasses.forEach(currentSc => {
                    const dropdown = currentSc.querySelector('.dependsOn');
                    const currentId = currentSc.id;
                    const selectedValue = dropdown.value;
                    dropdown.innerHTML = '<option value="">None</option>';
                    options.forEach(opt => {
                        if (opt.id !== currentId) {
                            dropdown.innerHTML += `<option value="${opt.id}">${opt.name}</option>`;
                        }
                    });
                    dropdown.value = selectedValue;
                });
            }
            
            // --- EVENT BINDING ---
            setupModeSwitcher();
            cloneTemplateToSingleForm();
            calculateAndDisplaySingleScore();

            document.getElementById('calculateBtn').addEventListener('click', calculateAndDisplaySingleScore);
            document.getElementById('addVulnerabilityBtn').addEventListener('click', addVulnerabilitySubclass);
            document.getElementById('calculateChainBtn').addEventListener('click', () => calculateAndDisplayChainScore(false));
            
            chainContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-subclass-btn')) {
                    e.target.closest('.vulnerability-subclass').remove();
                    updateAllDependencyDropdowns();
                    calculateAndDisplayChainScore(true);
                }
            });

            // --- CORE SCORING LOGIC ---
            function getVulnerabilityData(container) {
                const data = {};
                container.querySelectorAll('select, input[type="text"], input[type="checkbox"]').forEach(el => {
                    const key = el.className.split(' ')[0];
                    data[key] = el.type === 'checkbox' ? el.checked : el.value;
                });
                data.confSubclass = data.confidentiality === 'N' ? null : container.querySelector('.confDataSensitivity').value;
                data.intSubclass = data.integrity === 'N' ? null : container.querySelector('.intDataSensitivity').value;
                data.id = container.id;
                data.name = container.querySelector('.vulnerabilityName').value.trim() || `Unnamed (${container.id.slice(-4)})`;
                const dependsOnSelect = container.querySelector('.dependsOn');
                data.dependsOn = dependsOnSelect ? dependsOnSelect.value : '';
                return data;
            };
            
            function calculateScoreFromData(data) {
                 const mapUserRoleToPR = (userRole) => ({ admin: 'L', manager: 'L', new_merchant: 'N', customer: 'N' }[userRole] || 'N');
                 
                 const calculatePrivilegeImpact = (d) => {
                    let impact = 0;
                    let combinedBonus = 1.0;
                    if(d.cross_read) impact += escalationMultipliers.cross_read;
                    if(d.cross_write) impact += escalationMultipliers.cross_write;
                    if(d.same_read) impact += escalationMultipliers.same_read;
                    if(d.same_write) impact += escalationMultipliers.same_write;
                    if(d.token_escalation) impact += escalationMultipliers.token;
                    if(d.cross_read && d.cross_write) combinedBonus = Math.max(combinedBonus, 1.2);
                    if(d.same_read && d.same_write) combinedBonus = Math.max(combinedBonus, 1.15);
                    return impact * combinedBonus;
                };

                 const pr = mapUserRoleToPR(data.userRole);
                 const iscBase = 1 - ((1 - vectorValues.C[data.confidentiality]) * (1 - vectorValues.I[data.integrity]) * (1 - vectorValues.A[data.availability]));
                 
                 let impactScore = data.scope === 'U' ? (6.42 * iscBase) : (7.52 * (iscBase - 0.029) - 3.25 * Math.pow(iscBase - 0.02, 15));
                 
                 const exploitability = 8.22 * vectorValues.AV[data.attackVector] * vectorValues.AC[data.attackComplexity] * vectorValues.PR[data.scope][pr] * vectorValues.UI[data.userInteraction];
                 
                 let cvssBase = impactScore <= 0 ? 0 : (data.scope === 'U' ? Math.min(10, impactScore + exploitability) : Math.min(10, 1.08 * (impactScore + exploitability)));
                 cvssBase = Math.round(cvssBase * 10) / 10;
                 
                 const confMultiplier = data.confSubclass ? impactMultipliers[data.confSubclass] : 1;
                 const intMultiplier = data.intSubclass ? impactMultipliers[data.intSubclass] : 1;
                 const assetModifier = assetClassMultipliers[data.assetClass] || 1.0;
                 const privilegeImpact = calculatePrivilegeImpact(data);
                 const pciModifier = data.pciDss ? pciDssMultiplier : 1.0;
                 const roleModifier = userRoleScores[data.userRole] / 100;
                 const businessModifier = businessLogicMultipliers[data.businessLogic] || 1.0;
                 
                 let dataImpactValue = (confMultiplier + intMultiplier) / 2;
                 if ((data.confSubclass === 'red' || data.confSubclass === 'orange' || data.intSubclass === 'red' || data.intSubclass === 'orange') && !data.pciDss) {
                     dataImpactValue *= criticalDataBoost;
                 }
                 
                 let combinedModifier = dataImpactValue * assetModifier * privilegeImpact * pciModifier * roleModifier * businessModifier;
                 combinedModifier = Math.min(combinedModifier, 3.5);
                 
                 let baseRisk = cvssBase * combinedModifier;
                 let strictScore = 1000 * Math.pow(baseRisk / 20, 0.85);
                 if (strictScore > 850) {
                     strictScore = 850 + (150 * Math.log10(1 + (strictScore - 850) / 150));
                 }
                 const whiskScore = Math.round(Math.min(1000, Math.max(0, strictScore)));
                 
                 return { whiskScore, cvssBase, dataImpactValue, businessModifier, pciModifier };
            };
            
            function getRiskLevel(score) {
                if(score >= 900) return { level: "CRITICAL", color: '#dc2626' };
                if(score >= 700) return { level: "HIGH", color: '#f59e0b' };
                if(score >= 400) return { level: "MEDIUM", color: '#3b82f6' };
                return { level: "LOW", color: '#16a34a' };
            }

            // --- UI DISPLAY FUNCTIONS ---
            function calculateAndDisplaySingleScore() {
                const results = calculateScoreFromData(getVulnerabilityData(document.querySelector('#single-vulnerability-form .vulnerability-subclass')));
                document.getElementById('riskScore').textContent = results.whiskScore;
                const riskInfo = getRiskLevel(results.whiskScore);
                document.getElementById('riskLevel').textContent = riskInfo.level + " RISK";
                document.getElementById('riskLevel').style.color = riskInfo.color;
                document.getElementById('baseScore').textContent = results.cvssBase.toFixed(1);
                document.getElementById('dataImpact').textContent = results.dataImpactValue.toFixed(2) + 'x';
                document.getElementById('businessImpact').textContent = results.businessModifier.toFixed(1) + 'x';
                document.getElementById('pciMod').textContent = results.pciModifier.toFixed(1) + 'x';
            }

            function calculateAndDisplayChainScore(isLiveUpdate = false) {
                const subclasses = Array.from(chainContainer.querySelectorAll('.vulnerability-subclass'));
                if (subclasses.length === 0) {
                    document.getElementById('chain-results-panel').style.display = 'none';
                    return;
                }
                document.getElementById('chain-results-panel').style.display = 'grid';

                const allVulns = subclasses.map(sc => ({...getVulnerabilityData(sc), ...calculateScoreFromData(getVulnerabilityData(sc))}));
                const overallScore = allVulns.length > 0 ? Math.max(...allVulns.map(v => v.whiskScore)) : 0;
                
                document.getElementById('overallRiskScore').textContent = overallScore;
                const overallRiskInfo = getRiskLevel(overallScore);
                document.getElementById('overallRiskLevel').textContent = overallRiskInfo.level + " RISK";
                document.getElementById('overallRiskLevel').style.color = overallRiskInfo.color;

                const { prioritization } = calculatePrioritizationAndReduction(allVulns, overallScore);
                const prioList = document.getElementById('prioritization-list');
                prioList.innerHTML = '';
                prioritization.forEach(p => {
                    prioList.innerHTML += `
                        <li class="prio-item">
                            <div class="prio-info">
                                <span class="prio-name">${p.name}</span>
                                <span class="prio-reason prio-level-${p.rank}">${p.reason}</span>
                            </div>
                            <div class="prio-impact">
                                <span class="prio-reduction-label">Fix Impact</span>
                                <span class="prio-reduction-value">${p.reduction.toFixed(0)}%</span>
                            </div>
                        </li>`;
                });

                drawDependencyGraph(allVulns);
            }

             function calculatePrioritizationAndReduction(allVulns, currentOverallScore) {
                const dependents = {};
                allVulns.forEach(v => { dependents[v.id] = []; });
                allVulns.forEach(v => { if (v.dependsOn && dependents[v.dependsOn]) { dependents[v.dependsOn].push(v.id); }});
                
                const findDependenciesRecursive = (id, allDeps = new Set()) => {
                    if (dependents[id]) {
                        dependents[id].forEach(depId => {
                            if (!allDeps.has(depId)) {
                                allDeps.add(depId);
                                findDependenciesRecursive(depId, allDeps);
                            }
                        });
                    }
                    return allDeps;
                };

                const prioritization = allVulns.map(v => {
                    const isDependedOn = Object.values(dependents).some(deps => deps.includes(v.id));
                    const hasDependencies = v.dependsOn !== '';
                    let rank, reason;
                    if (!hasDependencies) { rank = 1; reason = "Root Cause"; } 
                    else if (!isDependedOn) { rank = 3; reason = "End of Chain"; } 
                    else { rank = 2; reason = "Intermediate"; }

                    const dependentVulns = findDependenciesRecursive(v.id);
                    dependentVulns.add(v.id);
                    const remainingVulns = allVulns.filter(v => !dependentVulns.has(v.id));
                    const newScore = remainingVulns.length > 0 ? Math.max(...remainingVulns.map(v => v.whiskScore)) : 0;
                    const reduction = currentOverallScore > 0 ? ((currentOverallScore - newScore) / currentOverallScore) * 100 : (allVulns.length > 0 ? 100 : 0);

                    return { ...v, rank, reason, reduction };
                }).sort((a, b) => a.rank - b.rank || b.reduction - a.reduction || b.whiskScore - a.whiskScore);
                
                return { prioritization };
            }

            function drawDependencyGraph(nodes) {
                const svg = document.getElementById('dependency-graph');
                svg.innerHTML = '';
                const width = svg.clientWidth;
                if (width === 0) return;
                const height = Math.max(400, nodes.length * 80);
                svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

                const nodeElements = {};
                const nodePositions = {};
                
                const { prioritization } = calculatePrioritizationAndReduction(nodes, 0);
                const nodeMap = new Map(prioritization.map(n => [n.id, n]));

                const columns = [ [], [], [] ]; 
                nodeMap.forEach(node => {
                    if (node.rank === 1) columns[0].push(node);
                    else if (node.rank === 2) columns[1].push(node);
                    else columns[2].push(node);
                });
                
                columns.forEach((col, colIndex) => {
                    col.sort((a,b) => b.whiskScore - a.whiskScore);
                    col.forEach((node, rowIndex) => {
                        nodePositions[node.id] = {
                            x: (colIndex * (width / 3)) + (width / 6),
                            y: (rowIndex * (height / (col.length || 1))) + (height / ((col.length || 1) * 2))
                        };
                    });
                });

                nodes.forEach(node => {
                    if (node.dependsOn && nodePositions[node.dependsOn] && nodePositions[node.id]) {
                        const start = nodePositions[node.dependsOn];
                        const end = nodePositions[node.id];
                        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        line.setAttribute('x1', start.x); line.setAttribute('y1', start.y);
                        line.setAttribute('x2', end.x); line.setAttribute('y2', end.y);
                        line.setAttribute('class', 'graph-link');
                        line.setAttribute('marker-end', 'url(#arrow)');
                        svg.appendChild(line);
                    }
                });

                nodes.forEach(node => {
                    const pos = nodePositions[node.id];
                    if (!pos) return;
                    
                    const riskInfo = getRiskLevel(node.whiskScore);
                    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                    g.setAttribute('class', 'graph-node');
                    g.setAttribute('transform', `translate(${pos.x}, ${pos.y})`);
                    g.dataset.id = node.id;

                    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('r', 35);
                    circle.setAttribute('fill', riskInfo.color);
                    circle.setAttribute('stroke', 'rgba(255,255,255,0.5)');
                    circle.setAttribute('stroke-width', 2);

                    const textName = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textName.setAttribute('text-anchor', 'middle');
                    textName.setAttribute('dy', '-5px');
                    textName.textContent = node.name.length > 15 ? node.name.substring(0,12)+'...' : node.name;
                    
                    const textScore = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textScore.setAttribute('text-anchor', 'middle');
                    textScore.setAttribute('dy', '15px');
                    textScore.style.fontWeight = 'bold';
                    textScore.textContent = node.whiskScore;

                    g.appendChild(circle); g.appendChild(textName); g.appendChild(textScore);
                    svg.appendChild(g);
                    nodeElements[node.id] = g;
                });

                svg.innerHTML += `<defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="rgba(255,255,255,0.3)" /></marker></defs>`;
            
                Object.values(nodeElements).forEach(g => {
                    g.addEventListener('click', () => {
                        const form = document.getElementById(g.dataset.id);
                        document.querySelectorAll('.vulnerability-subclass.highlight').forEach(el => el.classList.remove('highlight'));
                        form.classList.add('highlight');
                        form.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                });
            }

        });
    </script>
</body>
</html>
